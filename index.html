<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8">
    <title>VR Cycling - Debug Mode</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <style>
      #ui-container {
        position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
        z-index: 999; font-family: sans-serif; background: rgba(0,0,0,0.9);
        padding: 30px; border-radius: 20px; color: white; text-align: center; width: 350px;
      }
      .btn-connect {
        padding: 20px; font-size: 18px; background-color: #008CBA; color: white;
        border: none; border-radius: 10px; cursor: pointer; width: 100%; font-weight: bold;
      }
      /* Consola para ver errores dentro de la gafa */
      #debug-log {
        margin-top: 15px; font-family: monospace; font-size: 12px;
        color: #ffca28; text-align: left; background: #222; padding: 10px;
        max-height: 100px; overflow-y: auto; border: 1px solid #444;
      }
    </style>
  </head>
  <body>

    <div id="ui-container">
      <button class="btn-connect" onclick="conectarSensor()">CONECTAR SENSOR</button>
      <div id="debug-log">Log: Esperando acción...</div>
    </div>

    <a-scene>
      <a-assets>
        <video id="video_asset" src="video_recorrido.mp4" preload="auto" loop="true" crossorigin="anonymous" playsinline webkit-playsinline muted></video>
        <audio id="audio_ambiente" src="ambiente.mp3" loop="true" preload="auto"></audio>
      </a-assets>
      <a-videosphere src="#video_asset" rotation="0 -90 0"></a-videosphere>
      <a-camera look-controls></a-camera>
    </a-scene>

    <script>
      const video = document.getElementById('video_asset');
      const audio = document.getElementById('audio_ambiente');
      const log = document.getElementById('debug-log');
      const uiContainer = document.getElementById('ui-container');

      function printLog(msg) {
        log.innerText = "Log: " + msg;
        console.log(msg);
      }

      // --- SIMULADOR OCULTO ---
      window.addEventListener('keydown', (e) => {
        if (e.code === 'Space') {
          printLog("Tecla Espacio detectada");
          if (video.paused) video.play().catch(e => printLog("Error Play Video: " + e.message));
          if (audio.paused) audio.play().catch(e => printLog("Error Play Audio: " + e.message));
          registrarMovimiento();
        }
      });

      async function conectarSensor() {
        const SERVICE_UUID = '00001816-0000-1000-8000-00805f9b34fb';
        const CHAR_UUID = '00002a5b-0000-1000-8000-00805f9b34fb';

        try {
          printLog("Llamando a requestDevice...");
          
          // El primer clic activa el audio
          audio.play().catch(() => {});

          const device = await navigator.bluetooth.requestDevice({
            filters: [{ services: [SERVICE_UUID] }]
          });

          printLog("Dispositivo encontrado: " + device.name);
          const server = await device.gatt.connect();
          printLog("GATT Conectado");
          
          const service = await server.getPrimaryService(SERVICE_UUID);
          const characteristic = await service.getCharacteristic(CHAR_UUID);

          await characteristic.startNotifications();
          printLog("Notificaciones activas. ¡Pedalea!");

          characteristic.addEventListener('characteristicvaluechanged', (e) => {
            registrarMovimiento();
          });

          // Ocultar interfaz tras éxito
          setTimeout(() => { uiContainer.style.display = 'none'; }, 3000);

        } catch (error) {
          printLog("ERROR: " + error.name + " - " + error.message);
        }
      }

      let targetRate = 0;
      let currentRate = 0;
      let stopTimeout;

      function registrarMovimiento() {
        targetRate = 1.0;
        if (video.paused) video.play().catch(() => {});
        clearTimeout(stopTimeout);
        stopTimeout = setTimeout(() => { targetRate = 0; }, 1500);
      }

      function updateInertia() {
        let suavizado = (targetRate > currentRate) ? 0.015 : 0.025;
        currentRate += (targetRate - currentRate) * suavizado;
        if (video.readyState >= 2) {
          if (currentRate > 0.1) {
            video.playbackRate = currentRate;
            if (video.paused) video.play().catch(() => {});
          } else {
            video.playbackRate = 0;
            if (!video.paused && targetRate === 0) video.pause();
          }
        }
        requestAnimationFrame(updateInertia);
      }
      updateInertia();
    </script>
  </body>
</html>
