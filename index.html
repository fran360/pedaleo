<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>VR Cycling - Aceleración Suave</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <style>
      #ui-container {
        position: absolute; top: 20px; left: 20px; z-index: 999;
        font-family: sans-serif; background: rgba(0,0,0,0.8);
        padding: 20px; border-radius: 10px; color: white; max-width: 300px;
      }
      .btn-connect {
        padding: 15px 25px; font-size: 18px; background-color: #008CBA;
        color: white; border: none; border-radius: 8px; cursor: pointer;
        width: 100%; margin-bottom: 10px;
      }
      #status { font-size: 14px; font-weight: bold; }
      .instrucciones { font-size: 12px; color: #bbb; margin-top: 10px; line-height: 1.4; }
    </style>
  </head>
  <body>

    <div id="ui-container">
      <button class="btn-connect" onclick="conectarSensor()">1. Conectar Sensor Magene</button>
      <div id="status">Estado: Esperando conexión...</div>
      <div class="instrucciones">
        <strong>Prueba de inercia:</strong> Haz clic y pulsa <strong>ESPACIO</strong>. Verás que ahora arranca y frena con suavidad.
      </div>
    </div>

    <a-scene>
      <a-assets>
        <video id="video_asset" src="video_recorrido.mp4" preload="auto" loop="true" crossorigin="anonymous" playsinline webkit-playsinline muted></video>
      </a-assets>
      <a-videosphere src="#video_asset" rotation="0 -90 0"></a-videosphere>
      <a-camera><a-cursor color="#FFF" fuse="false"></a-cursor></a-camera>
    </a-scene>

    <script>
      const video = document.getElementById('video_asset');
      const statusText = document.getElementById('status');
      const uiContainer = document.getElementById('ui-container');
      
      let targetPlaybackRate = 0;
      let currentPlaybackRate = 0;
      let isPedaling = false;
      let stopTimeout;
      let lastRevolutions = -1;

      // AJUSTES DE SENSACIÓN (Puedes tocar estos números)
      const ACELERACION = 0.015; // Menor número = arranque más lento y pesado
      const FRENADO = 0.025;     // Menor número = frena más lentamente (más inercia)

      window.addEventListener('keydown', (e) => {
        if (e.code === 'Space') {
          if (video.paused) video.play().catch(() => {});
          registrarMovimiento();
        }
      });

      async function conectarSensor() {
        const CSC_SERVICE_UUID = '00001816-0000-1000-8000-00805f9b34fb';
        const CSC_CHARACTERISTIC_UUID = '00002a5b-0000-1000-8000-00805f9b34fb';
        try {
          statusText.innerText = "Buscando sensor...";
          const device = await navigator.bluetooth.requestDevice({ filters: [{ services: [CSC_SERVICE_UUID] }] });
          const server = await device.gatt.connect();
          const service = await server.getPrimaryService(CSC_SERVICE_UUID);
          const characteristic = await service.getCharacteristic(CSC_CHARACTERISTIC_UUID);
          await characteristic.startNotifications();
          characteristic.addEventListener('characteristicvaluechanged', (event) => {
            let value = event.target.value;
            let cumulativeRev = value.getUint16(1, true); 
            if (lastRevolutions !== -1 && cumulativeRev !== lastRevolutions) registrarMovimiento();
            lastRevolutions = cumulativeRev;
          });
          statusText.innerText = "¡CONECTADO!";
          statusText.style.color = "#00FF00";
          setTimeout(() => { uiContainer.style.opacity = "0"; setTimeout(() => uiContainer.style.display = 'none', 1000); }, 3000);
        } catch (error) { statusText.innerText = "Error: " + error; }
      }

      function registrarMovimiento() {
        isPedaling = true;
        targetPlaybackRate = 1.0; 
        if (video.paused) video.play().catch(() => {});
        clearTimeout(stopTimeout);
        stopTimeout = setTimeout(() => {
          isPedaling = false;
          targetPlaybackRate = 0;
        }, 1500); 
      }

      function updateInertia() {
        // Elegimos qué suavizado aplicar según si estamos acelerando o frenando
        let factorSuavizado = (targetPlaybackRate > currentPlaybackRate) ? ACELERACION : FRENADO;

        // Cálculo de la velocidad actual
        currentPlaybackRate += (targetPlaybackRate - currentPlaybackRate) * factorSuavizado;

        if (video.readyState >= 2) {
          if (currentPlaybackRate > 0.1) {
            try {
              video.playbackRate = currentPlaybackRate;
              if (video.paused) video.play().catch(() => {});
            } catch (e) {}
          } else {
            try {
              if (video.playbackRate !== 0) video.playbackRate = 0;
              if (!isPedaling && !video.paused) video.pause();
            } catch (e) {}
          }
        }
        requestAnimationFrame(updateInertia);
      }

      updateInertia();
    </script>
  </body>
</html>
