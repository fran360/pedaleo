<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8">
    <title>VR Cycling - Test Final</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <style>
      #ui-container {
        position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
        z-index: 999; font-family: sans-serif; background: rgba(0,0,0,0.8);
        padding: 25px; border-radius: 15px; color: white; text-align: center; width: 300px;
        transition: opacity 1s;
      }
      .btn-connect {
        padding: 15px; font-size: 18px; background-color: #008CBA; color: white;
        border: none; border-radius: 8px; cursor: pointer; width: 100%; font-weight: bold;
      }
      #data-display { margin-top: 10px; font-size: 12px; color: #4CAF50; }
    </style>
  </head>
  <body>

    <div id="ui-container">
      <button class="btn-connect" onclick="conectarSensor()">ENLAZAR SENSOR</button>
      <div id="data-display">Esperando sensor...</div>
    </div>

    <a-scene>
      <a-assets>
        <video id="video_asset" src="video_recorrido.mp4" preload="auto" loop="true" 
               crossorigin="anonymous" playsinline webkit-playsinline muted></video>
        <audio id="audio_ambiente" src="ambiente.mp3" loop="true" preload="auto"></audio>
      </a-assets>
      <a-videosphere src="#video_asset" rotation="0 -90 0"></a-videosphere>
      <a-camera look-controls></a-camera>
    </a-scene>

    <script>
      const video = document.getElementById('video_asset');
      const audio = document.getElementById('audio_ambiente');
      const dataDisplay = document.getElementById('data-display');
      const uiContainer = document.getElementById('ui-container');

      let lastRevolutions = -1;
      let targetRate = 0;
      let currentRate = 0;
      let stopTimeout;

      async function conectarSensor() {
        try {
          // 1. FORZAR PLAY: Desbloqueamos audio y video con el clic del botón
          video.play().then(() => { video.pause(); }); 
          audio.play().catch(() => {});

          const device = await navigator.bluetooth.requestDevice({
            filters: [{ services: ['00001816-0000-1000-8000-00805f9b34fb'] }]
          });

          const server = await device.gatt.connect();
          const service = await server.getPrimaryService('00001816-0000-1000-8000-00805f9b34fb');
          const characteristic = await service.getCharacteristic('00002a5b-0000-1000-8000-00805f9b34fb');

          await characteristic.startNotifications();

          characteristic.addEventListener('characteristicvaluechanged', (event) => {
            const value = event.target.value;
            const flags = value.getUint8(0);
            let offset = 1;
            if (flags & 0x01) offset += 6; // Saltar datos de rueda si existen
            
            const cumulativeRev = value.getUint16(offset, true);
            dataDisplay.innerText = "Pedaladas detectadas: " + cumulativeRev;

            if (lastRevolutions !== -1 && cumulativeRev !== lastRevolutions) {
              registrarMovimiento();
            }
            lastRevolutions = cumulativeRev;
          });

          dataDisplay.innerText = "¡CONECTADO! Empieza a pedalear.";
          // Ocultar UI parcialmente para no molestar
          setTimeout(() => { uiContainer.style.opacity = "0.3"; }, 3000);

        } catch (error) {
          dataDisplay.innerText = "Error: " + error.message;
        }
      }

      function registrarMovimiento() {
        targetRate = 1.0; 
        // Forzamos el play cada vez que detectamos movimiento real
        if (video.paused) video.play().catch(() => {});
        
        clearTimeout(stopTimeout);
        stopTimeout = setTimeout(() => {
          targetRate = 0;
        }, 1800); // Margen de 1.8 segundos entre pedaladas
      }

      function updateInertia() {
        // Suavizado de aceleración y frenado
        let suavizado = (targetRate > currentRate) ? 0.02 : 0.04;
        currentRate += (targetRate - currentRate) * suavizado;

        // Si hay velocidad suficiente, aplicamos al video
        if (currentRate > 0.02) {
          video.playbackRate = currentRate;
          if (video.paused) video.play().catch(() => {});
        } else {
          // Parada suave
          if (video.playbackRate !== 0) video.playbackRate = 0;
          if (!video.paused && targetRate === 0) video.pause();
        }
        
        requestAnimationFrame(updateInertia);
      }

      // Arrancar el bucle de renderizado
      updateInertia();
    </script>
  </body>
</html>
